#!/bin/sh

# Script to translate using GNU Gettext.

source "$( cd "$( dirname "$0" )" && pwd )/common"

####### CONFIG #################################################################

LARAVEL_DIR="`laravel_dir`"

# Where to look for files ...
APP_DIR="$LARAVEL_DIR/app"

# What files to look for ...
EXT="*.php"

# Directory (relative to $APP_DIR) where translations will be stored
LOCALE_DIR="lang"

####### DO NOT MODIFY BELOW HERE ###############################################

color "Compiling Blade view files"
php $LARAVEL_DIR/artisan gettext

# Choose locale
color "Choose language you are going to transtale into:
	1.- English
	2.- Spanish" "yellow"
read LOCALE
case "$LOCALE" in
	"1" )LOCALE="en_US";;
	"2" )LOCALE="es_ES";;
	*)exit;;
esac

# Create destination dir
DIR="$APP_DIR/$LOCALE_DIR/$LOCALE/LC_MESSAGES"
mkdir -p "$DIR" || exit_error "Unable to create $DIR"

# Generate .pot template
TEMPLATE_FILE="$DIR/messages.pot"
find "$APP_DIR" -type f -iname "$EXT" | xgettext --no-wrap --sort-output --no-location --from-code=UTF-8 -o- -f- | sed "s,$APP_DIR,,g" | sed "s,; charset=CHARSET,; charset=UTF-8,g" > $TEMPLATE_FILE

# If an old translation exists, make a copy and merge it with the new template
TRANSLATED_FILE="$DIR/messages.po"
if [ -f "$TRANSLATED_FILE" ]; then
	cp "$TRANSLATED_FILE" "$TRANSLATED_FILE".old
	msgmerge --no-wrap -q -v -o "$TRANSLATED_FILE" "$TRANSLATED_FILE" "$TEMPLATE_FILE" || exit_error "Unable to merge old translation"
else
	#msginit --no-wrap --no-translator --locale=$LOCALE --input="$TEMPLATE_FILE" --output-file="$TRANSLATED_FILE" || exit_error "Unable to init translation"
	cp "$TEMPLATE_FILE" "$TRANSLATED_FILE"
fi

# Translate
#$EDITOR "$TRANSLATED_FILE" > /dev/null 2>&1
\kate "$TRANSLATED_FILE" > /dev/null 2>&1

# Generate binary catalog file
msgfmt --verbose --output-file "$DIR/messages.mo" "$TRANSLATED_FILE" || exit_error "Unable to generae binary catalog"

exit $?
